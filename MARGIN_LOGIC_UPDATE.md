# Обновление логики расчета наценок

## Изменения в логике

### Старая логика (исправлена)
Раньше все валютные пары использовали одинаковую логику: `базовый_курс * (1 + наценка/100)`

### Новая логика

#### 1. RUB/X (рубль → валюта) - ПЛЮС наценка
- **Пример пары**: RUB/USD, RUB/EUR
- **Логика**: `базовый_курс * (1 + наценка/100)`
- **Описание**: Когда пользователь вводит +2%, курс увеличивается на 2%
- **Практический пример**:
  - Базовый курс: 1 RUB = 0.012 USD
  - Наценка пользователя: +5%
  - Итоговый курс: 1 RUB = 0.0126 USD (увеличение)

#### 2. X/RUB (валюта → рубли) - МИНУС наценка
- **Пример пары**: USD/RUB, EUR/RUB, USDT/RUB
- **Логика**: `базовый_курс * (1 - наценка/100)`
- **Описание**: Когда пользователь вводит +2%, курс уменьшается на 2%
- **Практический пример**:
  - Базовый курс: 1 USD = 85 RUB
  - Наценка пользователя: +3%
  - Итоговый курс: 1 USD = 82.45 RUB (уменьшение)

## Измененные файлы

### `src/handlers/calculation_logic.py`
- Обновлен метод `calculate_rub_quote_margin()` - теперь использует вычитание вместо сложения
- Улучшена документация и комментарии
- Исправлено форматирование кода для соответствия PEP 8

### `tests/test_banking_logic.py`
- Добавлен новый тест `test_margin_logic()` для проверки корректности логики
- Обновлен `test_all_pairs()` для отображения типа логики

## Тестирование

### Основные тесты
1. **RUB/USD** с наценкой +2% → курс увеличивается ✅
2. **USD/RUB** с наценкой +2% → курс уменьшается ✅
3. **USDT/RUB** с наценкой +3% → курс уменьшается ✅

### Крайние случаи
1. **Нулевая наценка** → курс остается неизменным ✅
2. **Отрицательная наценка** → логика инвертируется ✅

### Практические примеры
- Обмен 1000 RUB → USD с +5% → получаем больше долларов ✅
- Обмен 100 USD → RUB с +3% → получаем меньше рублей ✅
- Обмен 500 USDT → RUB с +2.5% → получаем меньше рублей ✅

## Обратная совместимость

Изменения полностью обратно совместимы:
- Старые API и методы продолжают работать
- Существующие тесты проходят успешно
- Пользовательский интерфейс не изменился

## Документация

Обновлены комментарии в коде, чтобы четко описать новую логику:
- `calculate_rub_base_margin()` - для пар RUB/X (ПЛЮС наценка)
- `calculate_rub_quote_margin()` - для пар X/RUB (МИНУС наценка)

## Заключение

Новая логика обеспечивает более интуитивное поведение для пользователей:
- При обмене рублей на валюту - получают больше валюты при положительной наценке
- При обмене валюты на рубли - получают меньше рублей при положительной наценке (что логично для обменника)

Все изменения протестированы и готовы к продакшену.