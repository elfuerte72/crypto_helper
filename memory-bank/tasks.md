# TASKS - Crypto Helper Telegram Bot

## Описание задачи
Минималистичный MVP Telegram-бот для автоматизации получения курсов криптовалют и расчета наценки для менеджеров в канале.

## Уровень сложности
**Уровень: 3 (Intermediate Feature)**
**Тип: Feature Development**

## Технологический стек
- **Язык**: Python 3.11
- **Telegram Bot Framework**: Aiogram 3.10
- **HTTP Client**: aiohttp
- **Конфигурация**: python-dotenv
- **API**: Rapira API для получения курсов
- **Хранилище**: Не требуется (MVP)

## Контрольные точки технологической валидации
- [x] Инициализация проекта Python 3.13 проверена ✅
- [x] Зависимости Aiogram 3.10.0, aiohttp 3.9.1, python-dotenv 1.0.0 установлены ✅
- [x] Конфигурация сборки валидирована (requirements.txt, .env.example) ✅
- [x] Hello World бот создан и структура протестирована ✅
- [x] Тестовая сборка успешно завершена (HTTP клиент, API структура) ✅

## Статус выполнения
- [x] Инициализация завершена ✅
- [x] Планирование завершено ✅
- [x] Технологическая валидация завершена ✅
- [x] Настройка окружения - ✅ ЗАВЕРШЕНО
- [x] Создание базовой структуры бота - ✅ ЗАВЕРШЕНО
- [x] Реализация команды /admin_bot - ✅ ЗАВЕРШЕНО
- [x] Проверка прав администратора - ✅ ЗАВЕРШЕНО
- [x] Интеграция с Rapira API - ✅ ЗАВЕРШЕНО
- [x] Реализация выбора валютных пар - ✅ ЗАВЕРШЕНО
- [x] Расчет курса с наценкой - ✅ ЗАВЕРШЕНО
- [x] Публикация результатов в канал - ✅ ЗАВЕРШЕНО
- [ ] Тестирование MVP

## План реализации

### Фаза 1: Настройка окружения и базовая структура ✅ ЗАВЕРШЕНО
1. **Создание проекта** ✅ ЗАВЕРШЕНО
   - [x] Инициализация Python проекта ✅
   - [x] Установка зависимостей (aiogram, aiohttp, python-dotenv) ✅
   - [x] Создание .env файла для конфигурации ✅
   - [x] Создание базовой структуры файлов ✅

2. **Базовый Telegram бот** ✅ ЗАВЕРШЕНО
   - [x] Создание основного файла бота (main.py) ✅
   - [x] Настройка aiogram диспетчера ✅
   - [x] Реализация базового обработчика команд ✅
   - [x] Тестирование подключения к Telegram API ✅

### Фаза 2: Основной функционал
3. **Команда /admin_bot** ✅ ЗАВЕРШЕНО
   - [x] Создание обработчика команды /admin_bot ✅
   - [x] Проверка прав администратора пользователя в канале ✅
   - [x] Создание inline клавиатуры для выбора валютных пар ✅

4. **Выбор валютных пар** ✅ ЗАВЕРШЕНО
   - [x] Реализация callback обработчиков для валютных пар ✅
   - [x] Поддержка RUB/ZAR, RUB/THB, RUB/AED, RUB/IDR ✅
   - [x] Поддержка USDT/ZAR, USDT/THB, USDT/AED, USDT/IDR ✅
   - [x] Поддержка обратных направлений ✅
   - [x] Детальная информация о валютных парах ✅
   - [x] Обработка ошибок выбора ✅
   - [x] Unit тесты для всей функциональности ✅

### Фаза 3: Интеграция с API и расчеты
5. **Интеграция с Rapira API** ✅ ЗАВЕРШЕНО
   - [x] Создание HTTP клиента для запросов к API ✅
   - [x] Получение текущих курсов для выбранной валютной пары ✅
   - [x] Обработка ошибок API ✅
   - [x] Система вычисления кросс-курсов ✅
   - [x] Комплексное тестирование ✅

6. **Расчет курса с наценкой** ✅ ЗАВЕРШЕНО
   - [x] Запрос процентной наценки у менеджера ✅
   - [x] Расчет итогового курса ✅
   - [x] Форматирование результата для публикации ✅
   - [x] FSM для управления диалогом с пользователем ✅
   - [x] Валидация процентной наценки (-100% до +1000%) ✅
   - [x] Предустановленные варианты наценки ✅
   - [x] Точные расчеты с использованием Decimal ✅
   - [x] Интерактивные клавиатуры для удобства ✅
   - [x] Обработка ошибок ввода ✅
   - [x] Unit тесты (31 тест, все проходят) ✅cd src 

### Фаза 4: Публикация и тестирование
7. **Публикация в канал** ✅ ЗАВЕРШЕНО
   - [x] Отправка рассчитанного курса в канал ✅
   - [x] Форматирование сообщения с курсом ✅
   - [x] Режим разработки - отправка в ЛС ✅
   - [x] Продакшен режим - публикация в канал ✅
   - [x] Обработка ошибок публикации ✅
   - [x] Unit тесты (18 тестов, все проходят) ✅

8. **Тестирование MVP**
   - Полное тестирование workflow
   - Проверка обработки ошибок
   - Валидация всех валютных пар

## Компоненты, требующие творческой фазы
- [x] **Дизайн пользовательского интерфейса**: Структура inline клавиатур и сообщений ✅ ЗАВЕРШЕНО
- [x] **Архитектура обработки состояний**: FSM для управления диалогом с менеджером ✅ ЗАВЕРШЕНО
- [x] **Дизайн API интеграции**: Обработка ошибок и retry логика ✅ ЗАВЕРШЕНО

## Зависимости
- Доступ к Telegram Bot API (токен бота)
- Доступ к Rapira API (ключ API, документация)
- Права администратора бота в целевом канале
- Python 3.11 окружение

## Вызовы и решения
- **Проверка прав администратора**: Использовать getChatMember API Telegram
- **Обработка состояний диалога**: Использовать FSM из aiogram
- **Обработка ошибок API**: Retry логика с exponential backoff
- **Валидация входных данных**: Проверка корректности процентной наценки
- **Безопасность**: Хранение токенов в .env файле

## Ограничения MVP
- Без сохранения истории сделок
- Без уведомлений и статистики
- Без сложных инструментов контроля качества
- Без архитектурных изысков
- Без CI/CD на начальном этапе

## Критерии готовности
- Бот успешно запускается и подключается к Telegram
- Команда /admin_bot работает только для администраторов канала
- Все 8 валютных пар (+ обратные) поддерживаются
- API Rapira интегрирован и возвращает актуальные курсы
- Расчет наценки работает корректно
- Результат публикуется в канал (или ЛС на этапе разработки)
- Обработка основных ошибок реализована